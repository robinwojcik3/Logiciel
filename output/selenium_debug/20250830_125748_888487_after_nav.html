<html lang="fr" data-theme="dark"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Patrimoniale de la Flore</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" href="leaflet.groupedlayercontrol.min.css">
    <script src="leaflet.groupedlayercontrol.min.js"></script>
    
    <!-- Biblioth√®ques pour l'export shapefile -->
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>
    <script src="shapefile.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shpjs@3.5.0/dist/shp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/geoportal-extensions-leaflet@latest/dist/GpPluginLeaflet.js"></script>

    <script defer="" src="ui.js"></script>
    <script defer="" src="biblio-patri.js"></script>
    <script defer="" src="sw-register.js"></script>
    <style>
      .logo-icon { width: 24px; height: auto; }
      .small-logo { height: 24px; width: auto; }
      #profile-container {
        position: absolute;
        bottom: 10px;
        left: 10px;
        display: none;
        z-index: 1000;
        gap: 4px;
        align-items: flex-start;
        overflow: visible;
      }
      #profile-container.expanded {
        left: 0;
        right: 0;
        bottom: 0;
        flex-direction: column;
        align-items: stretch;
      }
      #profile-canvas {
        width: 280px;
        height: 100px;
        display: block;
        background: rgba(255,255,255,0.9);
        border: 1px solid #000;
        border-radius: 4px;
      }
      #profile-container.expanded #profile-canvas {
        width: 100%;
      }
      #profile-info {
        background: rgba(255,255,255,0.9);
        border: 1px solid #000;
        border-radius: 4px;
        padding: 4px;
        font-size: 0.8rem;
        line-height: 1.2;
        color: #000;
        white-space: nowrap;
      }
      #profile-hover {
        position: absolute;
        top: 0;
        left: 0;
        transform: translateX(-50%);
        padding: 4px;
        font-size: 0.75rem;
        background: rgba(255,255,255,0.95);
        border: 1px solid #333;
        border-radius: 6px;
        color: #000;
        max-width: 200px;
        white-space: normal;
        word-break: break-word;
        pointer-events: none;
        display: none;
        z-index: 1002;
        opacity: 0;
        transition: opacity 0.25s ease-in-out;
      }
      .tooltip-alt {
        font-weight: 600;
        text-align: center;
        margin-bottom: 4px;
      }
      .tooltip-pill {
        display: block;
        padding: 6px 8px;
        border-radius: 12px;
        color: #fff;
        font-size: 0.75rem;
        line-height: 1.2;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        margin-top: 2px;
        word-break: break-word;
      }
      .vegetation-pill { background: #2E7D32; }
      .soil-pill { background: #8D6E63; }
      #profile-pills {
        position: absolute;
        left: 0;
        bottom: calc(100% + 4px);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        z-index: 1001;
      }
      .fixed-pill {
        display: inline-block;
        line-height: 1.2;
        height: calc(1.2em * 3 + 12px);
        white-space: normal;
        overflow: hidden;
      }
      #profile-margin-handle {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        cursor: n-resize;
        background: rgba(0,0,0,0.2);
      }
      #profile-resizer {
        position: absolute;
        right: 0;
        bottom: 0;
        width: 12px;
        height: 12px;
        cursor: ns-resize;
        background: rgba(0,0,0,0.2);
      }
      .profile-label {
        position: absolute;
        background: rgba(255,255,255,0.9);
        padding: 1px 2px;
        border-radius: 2px;
        font-size: 10px;
        white-space: nowrap;
        cursor: pointer;
      }
      .profile-popup {
        position: absolute;
        z-index: 1001;
        background: rgba(255,255,255,0.95);
        border: 1px solid #000;
        border-radius: 4px;
        padding: 4px;
        font-size: 0.8rem;
        color: #000;
      }
      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      .resource-btn {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.6rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-decoration: none;
        font-size: 0.9rem;
        color: var(--text);
        transition: transform .2s;
      }
      .resource-btn:hover { transform: scale(1.05); }
      .resource-icon { width: 24px; height: 24px; margin: 0; }
      .resources-popup {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }
      .altitude-info {
        grid-column: 1 / -1;
        text-align: center;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }
      .phenology-panel {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 4px;
      }
      .phenology-select {
        width: 100%;
        margin-top: 0.5rem;
      }
      .phenology-options {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
      }
      .phenology-label {
        text-align: center;
        margin-bottom: 0.5rem;
      }
      #import-popup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #import-popup .popup-content {
        background: var(--card);
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 90%;
      }
    </style>
<style>
        #notification-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; }
        .notification { padding: 10px 15px; margin-top: .5rem; border-radius: 4px; color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.3); font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .notification.success { background: #4caf50; }
        .notification.error { background: #e53935; }
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 1rem; }
        #modal-overlay.show { display: flex; }
        #modal-overlay .modal-content { background: var(--card, #fff); color: var(--text, #000); padding: 1rem 1.5rem; border-radius: 6px; max-width: 500px; width: 100%; }
        #modal-overlay .modal-close { float: right; cursor: pointer; background: none; border: none; font-size: 1.5rem; }
        #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,.7); display: none; align-items: center; justify-content: center; z-index: 4000; }
        #spinner-overlay.show { display: flex; }
        #spinner-overlay .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4caf50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style></head>
<body>
    <nav class="tabs-container">
        <div class="tabs">
            <button class="tab" onclick="window.location.href='index.html'">Identification</button>
            <button class="tab active">Carto</button>
            <button class="tab" onclick="window.location.href='phytosocio.html'">Phytosociologie</button>
        </div>
    </nav>
    <div id="section-nav" class="section-nav" style="display: none; top: 52px;">
        <button id="scroll-map-btn" class="nav-tab">Carte</button>
        <button id="scroll-table-btn" class="nav-tab">Tableau</button>
        <button id="eco-mode-toggle" class="nav-tab" style="display:none;">Mode comparatif</button>
    </div>
    <div class="main-content">
        <div class="search-controls">
            <div class="search-group address-group">
                <input type="text" id="address-input" placeholder="Saisir une adresse, une ville, un lieu...">
                <button id="search-address-btn" class="action-button">üîç Rechercher</button>
            </div>
            <div class="button-grid">
                <button id="use-geolocation-btn" class="action-button">üìç Ma position</button>
                <button id="draw-polygon-btn" class="action-button">üî∂ Zone personnalis√©e</button>
                <button id="draw-line-btn" class="action-button">üìè Lin√©aire</button>
                <button id="toggle-labels-btn" class="action-button">üè∑Ô∏è Masquer les √©tiquettes</button>
                <button id="upload-shapefile-btn" class="action-button">üìÅ Importer shapefile</button>
                <input type="file" id="shapefile-input" multiple="" accept=".zip,.shp,.dbf,.prj,.cpg,.shx,.qmd" style="display:none">
            </div>
            <div id="import-popup">
                <div class="popup-content">
                    <p>Quelle couche souhaitez-vous importer ?</p>
                    <button id="import-zone-btn" class="action-button">Zone d‚Äô√©tude</button>
                    <button id="import-aire-btn" class="action-button">Aire d‚Äô√©tude √©largie</button>
                </div>
            </div>
            <div class="search-group">
                <button id="phenology-btn" class="action-button" aria-expanded="false" style="display:none">Ph√©nologie</button>
                <div id="phenology-panel" class="phenology-panel" hidden="">
                    <label for="pheno-month" class="phenology-label">Mois</label>
                    <select id="pheno-month" class="phenology-select" aria-label="Mois">
                        <option value="0">Toute l'ann√©e</option>
                        <option value="1">Janvier</option>
                        <option value="2">F√©vrier</option>
                        <option value="3">Mars</option>
                        <option value="4">Avril</option>
                        <option value="5">Mai</option>
                        <option value="6">Juin</option>
                        <option value="7">Juillet</option>
                        <option value="8">Ao√ªt</option>
                        <option value="9">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                    <div class="phenology-options">
                        <label><input type="checkbox" id="pheno-include-missing"> inclure manquantes</label>
                        <button id="pheno-reset-btn" class="action-button">R√©initialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="status" class="status-container" style="display:none;">
            <span class="progress-label">GBIF</span>
            <div id="progress-container" style="display: none;"><div id="progress-bar"></div></div>
            <span id="status-message">Chargement des donn√©es...</span>
        </div>
        <div id="status-shp" class="status-container" style="display:none;">
            <span class="progress-label">Shapefile</span>
            <div id="shp-progress-container" style="display: none;"><div id="shp-progress-bar"></div></div>
            <span id="shp-status-message"></span>
        </div>



        <div id="map-table-wrapper">
            <div id="map">
                <div id="crosshair" style="display:none;"></div>
                <div id="profile-container">
                    <canvas id="profile-canvas" width="280" height="100"></canvas>
                    <div id="profile-info"></div>
                    <div id="profile-hover"></div>
                    <div id="profile-pills">
                        <div id="profile-veg-pill" class="tooltip-pill vegetation-pill fixed-pill"></div>
                        <div id="profile-soil-pill" class="tooltip-pill soil-pill fixed-pill"></div>
                    </div>
                    <div id="profile-margin-handle"></div>
                    <div id="profile-resizer"></div>
                </div>
            </div>

            <div id="side-panel">
                <div id="download-container" style="text-align:center; display:none; margin-bottom:1rem;">
                    <button id="download-shapefile-btn" class="action-button">‚¨áÔ∏è Shapefile</button>
                </div>

                <div id="resources-grid" class="results-grid" style="display:none; margin-bottom:1rem;"></div>

                <button id="table-placement-toggle" class="action-button" style="margin-bottom:1rem;">Tableau lat√©ral</button>

                <div id="results" class="results-container"></div>
            </div>
        </div>
    </div>


<div id="notification-container"></div><div id="modal-overlay"><div class="modal-content"><button class="modal-close" aria-label="Fermer">√ó</button><div class="modal-body"></div></div></div><div id="spinner-overlay"><div class="spinner"></div></div></body></html>